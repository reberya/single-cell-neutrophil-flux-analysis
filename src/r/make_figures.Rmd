---
title: "Visualize Immunometabolism Data"
output: html_notebook
---

# Summary
This notebook creates the figures for the immunometabolism publication.

```{r}
library(tidyverse)
library(ggplot2)
library(readxl)
library(reshape2)
library(ggrepel)
```

# Visualize time-course flux changes as heatmap
First, we'll load up the neutrophil data and preprocess it.
```{r, fig.width=10, fig.height=10}
filepath = "C:/Users/scott/Analysis/Immune/visualize_COBRA.xlsx"
df = read_excel(filepath, sheet="Flux")

# Get relevant data
data = df[, c(3, 5:7)]

# Melt and convert score to a value that is more easily interpretable
tmp = melt(data=data, id.vars="Reaction")
tmp$value = abs(tmp$value - 1)*100
```

Now let's create the flux heatmap.
```{r, fig.width=10, fig.height=10}
ggplot(tmp, aes(y=Reaction, x=variable, z=value)) +
  geom_tile(aes(fill=value)) +
  geom_text(aes(label=round(value, 4)), color='white') +
  scale_fill_viridis_c(option="magma", direction=1) +
  labs(fill='Flux Reduction (%)') +
  ggtitle("Neutrophil Metabolic Fluxes Fold Changes") +
  theme_minimal() +
  theme(text=element_text(size=16, 
                          family="Serif"))
```

Finally save the figure.
```{r}
savepath = "C:/Users/scott/Analysis/Immune/flux_heatmap.png"
ggsave(savepath,
       plot=last_plot(),
       device="png",
       width=10,
       height=10)
```

##Visualize time-course growth rate changes as heatmap
Again, load up the neutrophil growth rate fold change data.

```{r, fig.width=10, fig.height=10}
filepath = "C:/Users/scott/Analysis/Immune/visualize_COBRA.xlsx"
df = read_excel(filepath, sheet="Grate")
data = df[, c(3, 5:7)]
tmp = melt(data=data, id.vars="Reaction")
tmp$value = abs(tmp$value - 1)*100
```

This code block creates a heatmap of the growth rates
```{r, fig.width=10, fig.height=10}
ggplot(tmp, aes(y=Reaction, x=variable, z=value)) +
  geom_tile(aes(fill=value)) + 
  geom_text(aes(label=round(value, 4)), color='white') +
  scale_fill_viridis_c(option="magma", direction=1) +
  labs(fill='KO Sensitivity (%)', x="Time Transitions") +
  ggtitle("Neutrophil Reaction Knockout Sensitivity") +
  theme_minimal() +
  theme(text=element_text(size=16, 
                          family="Serif"))
```

Save it!
```{r} 
savepath = "C:/Users/scott/Analysis/Immune/grate_heatmap.png"
ggsave(savepath,
       plot=last_plot(),
       device="png",
       width=10,
       height=6)
```

## Visualize metabolic subsystems that are sensitive to knockout
This code creates barplots of each subsystem that are sensitive. First, preprocess the dataset.
```{r}
tmp = df %>%
  group_by(Subsystem) %>%
  count()

tmp = tmp[order(-tmp$n),]
tmp$n = as.numeric(tmp$n)
tmp$Subsystem = as.factor(tmp$Subsystem)
```

visualize the sorted barplot
```{r, fig.width=10, fig.height=10}
ggplot(tmp, 
       aes(x=reorder(Subsystem, n),
           y=n,
           fill=n)) + 
  geom_bar(stat='identity', 
           show.legend=FALSE) +
  theme_minimal() +
  theme(axis.text.x=element_text(vjust=0.5, hjust=1)) +
  labs(title="Metabolic subsystem sensitivity", 
       x="Metabolic subsystems", 
       y="Number of sensitive reactions") +
  coord_flip()

```

Save the figure.
```{r}
savepath = "C:/Users/scott/Analysis/Immune/subsystem_sensitivity_barplot.png"
ggsave(savepath,
       plot=last_plot(),
       device="png",
       width=10,
       height=6)
```

# Volcano plots of metabolic genes
We'll use the final_df_XXXX objects to visualize the volcano plots.

## Neutrophils
The plot code below creates the neutrophil plot.
```{r}
ggplot(data=mapped_0007[[10]], 
       aes(x=avg_logFC, 
           y=-log10(p_val_adj),
           label=HGNC.symbol)) +
       geom_point(alpha=0.1,
                  color=ifelse(mapped_0007[[10]]$p_val_adj<0.01, "red", "gray")) +
       geom_label_repel(data=mapped_0007[[10]] %>% filter(p_val_adj<1E-15),
                    aes(label=subset(mapped_0007[[10]]$HGNC.symbol,
                                     mapped_0007[[10]]$p_val_adj<1E-15)),
                    size=2, 
                    box.padding=0.5, 
                    max.overlaps=Inf) +
  
       geom_point(data=mapped_0714[[10]],
                 aes(x=avg_logFC,
                     y=-log10(p_val_adj)),
                     color=ifelse(mapped_0714[[10]]$p_val_adj<0.01, "red", "gray"),
                     alpha=0.50) +
       geom_label_repel(data=mapped_0714[[10]] %>% filter(p_val_adj<1E-15),
         aes(label=subset(mapped_0714[[10]]$HGNC.symbol, 
                          mapped_0714[[10]]$p_val_adj<1E-15)), 
                    box.padding=0.5, 
                    max.overlaps=Inf,
                    size=2) +
  
       geom_point(data=mapped_1421[[10]],
                 aes(x=avg_logFC,
                     y=-log10(p_val_adj)),
                     color=ifelse(mapped_1421[[10]]$p_val_adj<0.01, "red", "gray"),
                     alpha=1.0) +
       geom_label_repel(data=mapped_1421[[10]] %>% filter(p_val_adj<1E-15),
         aes(label=subset(mapped_1421[[10]]$HGNC.symbol, 
                                         mapped_1421[[10]]$p_val_adj<1E-15)),
                    size=2, 
                    box.padding=0.5, 
                    max.overlaps=Inf) +
  
       theme_minimal() +
       labs(title="Neutrophil metabolic gene differential expression", 
             x="Average log fold change", 
             y="-log Adj. P-value")
```
```{r}
savepath = "~/Analysis/Immune/volcano_neutrophils.png"
ggsave(savepath,
       plot=last_plot(),
       device="png",
       width=10,
       height=6)
```


## NK Cells
The code below plots the NK cell differential expression.
```{r}
ggplot(data=mapped_0007[[11]], 
       aes(x=avg_logFC, 
           y=-log10(p_val_adj),
           label=HGNC.symbol)) +
       geom_point(alpha=0.1,
                  color=ifelse(mapped_0007[[11]]$p_val_adj<0.01, "red", "gray")) +
       geom_label_repel(data=mapped_0007[[11]] %>% filter(p_val_adj<1E-15),
                    aes(label=subset(mapped_0007[[11]]$HGNC.symbol,
                                     mapped_0007[[11]]$p_val_adj<1E-15)),
                    size=2, 
                    box.padding=0.5, 
                    max.overlaps=Inf) +
  
       geom_point(data=mapped_0714[[11]],
                 aes(x=avg_logFC,
                     y=-log10(p_val_adj)),
                     color=ifelse(mapped_0714[[11]]$p_val_adj<0.01, "red", "gray"),
                     alpha=0.50) +
       geom_label_repel(data=mapped_0714[[11]] %>% filter(p_val_adj<1E-15),
         aes(label=subset(mapped_0714[[11]]$HGNC.symbol, 
                          mapped_0714[[11]]$p_val_adj<1E-15)), 
                    box.padding=0.5, 
                    max.overlaps=Inf,
                    size=2) +
  
       geom_point(data=mapped_1421[[11]],
                 aes(x=avg_logFC,
                     y=-log10(p_val_adj)),
                     color=ifelse(mapped_1421[[11]]$p_val_adj<0.01, "red", "gray"),
                     alpha=1.0) +
       geom_label_repel(data=mapped_1421[[11]] %>% filter(p_val_adj<1E-15),
         aes(label=subset(mapped_1421[[11]]$HGNC.symbol, 
                                         mapped_1421[[11]]$p_val_adj<1E-15)),
                    size=2, 
                    box.padding=0.5, 
                    max.overlaps=Inf) +
  
       theme_minimal() +
       labs(title="NK-cell metabolic gene differential expression", 
             x="Average log fold change", 
             y="-log Adj. P-value")
```

```{r}
savepath = "~/Analysis/Immune/volcano_nk.png"
ggsave(savepath,
       plot=last_plot(),
       device="png",
       width=10,
       height=6)
```

## T Cells
The code below plots the T cell differential expression.
```{r}
ggplot(data=mapped_0007[[8]], 
       aes(x=avg_logFC, 
           y=-log10(p_val_adj),
           label=HGNC.symbol)) +
       geom_point(alpha=0.1,
                  color=ifelse(mapped_0007[[8]]$p_val_adj<0.01, "red", "gray")) +
       geom_label_repel(data=mapped_0007[[8]] %>% filter(p_val_adj<0.01),
                    aes(label=subset(mapped_0007[[8]]$HGNC.symbol,
                                     mapped_0007[[8]]$p_val_adj<0.01)),
                    size=2, 
                    box.padding=0.5, 
                    max.overlaps=Inf) +
  
       geom_point(data=mapped_0714[[8]],
                 aes(x=avg_logFC,
                     y=-log10(p_val_adj)),
                     color=ifelse(mapped_0714[[8]]$p_val_adj<0.01, "red", "gray"),
                     alpha=0.50) +
       geom_label_repel(data=mapped_0714[[8]] %>% filter(p_val_adj<0.01),
         aes(label=subset(mapped_0714[[8]]$HGNC.symbol, 
                          mapped_0714[[8]]$p_val_adj<0.01)), 
                    box.padding=0.5, 
                    max.overlaps=Inf,
                    size=2) +
  
       geom_point(data=mapped_1421[[8]],
                 aes(x=avg_logFC,
                     y=-log10(p_val_adj)),
                     color=ifelse(mapped_1421[[8]]$p_val_adj<0.01, "red", "gray"),
                     alpha=1.0) +
       geom_label_repel(data=mapped_1421[[8]] %>% filter(p_val_adj<0.01),
         aes(label=subset(mapped_1421[[8]]$HGNC.symbol, 
                                         mapped_1421[[8]]$p_val_adj<0.01)),
                    size=2, 
                    box.padding=0.5, 
                    max.overlaps=Inf) +
  
       theme_minimal() +
       labs(title="T-cell metabolic gene differential expression", 
             x="Average log fold change", 
             y="-log Adj. P-value")
```

```{r}
savepath = "~/Analysis/Immune/volcano_tcell.png"
ggsave(savepath,
       plot=last_plot(),
       device="png",
       width=10,
       height=6)
```

## Monocytes
The code below plots the monocyte differential expression.
```{r}
ggplot(data=mapped_0007[[4]], 
       aes(x=avg_logFC, 
           y=-log10(p_val_adj),
           label=HGNC.symbol)) +
       geom_point(alpha=0.1,
                  color=ifelse(mapped_0007[[4]]$p_val_adj<0.01, "red", "gray")) +
       geom_label_repel(data=mapped_0007[[4]] %>% filter(p_val_adj<0.01),
                    aes(label=subset(mapped_0007[[4]]$HGNC.symbol,
                                     mapped_0007[[4]]$p_val_adj<0.01)),
                    size=2, 
                    box.padding=0.5, 
                    max.overlaps=Inf) +
  
       geom_point(data=mapped_0714[[4]],
                 aes(x=avg_logFC,
                     y=-log10(p_val_adj)),
                     color=ifelse(mapped_0714[[4]]$p_val_adj<0.01, "red", "gray"),
                     alpha=0.50) +
       geom_label_repel(data=mapped_0714[[4]] %>% filter(p_val_adj<0.01),
         aes(label=subset(mapped_0714[[4]]$HGNC.symbol, 
                          mapped_0714[[4]]$p_val_adj<0.01)), 
                    box.padding=0.5, 
                    max.overlaps=Inf,
                    size=2) +
  
       geom_point(data=mapped_1421[[4]],
                 aes(x=avg_logFC,
                     y=-log10(p_val_adj)),
                     color=ifelse(mapped_1421[[4]]$p_val_adj<0.01, "red", "gray"),
                     alpha=1.0) +
       geom_label_repel(data=mapped_1421[[4]] %>% filter(p_val_adj<0.01),
         aes(label=subset(mapped_1421[[4]]$HGNC.symbol, 
                                         mapped_1421[[4]]$p_val_adj<0.01)),
                    size=2, 
                    box.padding=0.5, 
                    max.overlaps=Inf) +
  
       theme_minimal() +
       labs(title="Monocyte metabolic gene differential expression", 
             x="Average log fold change", 
             y="-log Adj. P-value")
```

```{r}
savepath = "~/Analysis/Immune/volcano_monocyte.png"
ggsave(savepath,
       plot=last_plot(),
       device="png",
       width=10,
       height=6)
```

## HSC
The code below plots HSCs
```{r}
ggplot(data=mapped_0007[[13]], 
       aes(x=avg_logFC, 
           y=-log10(p_val_adj),
           label=HGNC.symbol)) +
       geom_point(alpha=0.1,
                  color=ifelse(mapped_0007[[13]]$p_val_adj<0.01, "red", "gray")) +
       geom_label_repel(data=mapped_0007[[13]] %>% filter(p_val_adj<0.01),
                    aes(label=subset(mapped_0007[[13]]$HGNC.symbol,
                                     mapped_0007[[13]]$p_val_adj<0.01)),
                    size=2, 
                    box.padding=0.5, 
                    max.overlaps=Inf) +
  
       geom_point(data=mapped_0714[[13]],
                 aes(x=avg_logFC,
                     y=-log10(p_val_adj)),
                     color=ifelse(mapped_0714[[13]]$p_val_adj<0.01, "red", "gray"),
                     alpha=0.50) +
       geom_label_repel(data=mapped_0714[[13]] %>% filter(p_val_adj<0.01),
         aes(label=subset(mapped_0714[[13]]$HGNC.symbol, 
                          mapped_0714[[13]]$p_val_adj<0.01)), 
                    box.padding=0.5, 
                    max.overlaps=Inf,
                    size=2) +
  
       geom_point(data=mapped_1421[[13]],
                 aes(x=avg_logFC,
                     y=-log10(p_val_adj)),
                     color=ifelse(mapped_1421[[13]]$p_val_adj<0.01, "red", "gray"),
                     alpha=1.0) +
       geom_label_repel(data=mapped_1421[[13]] %>% filter(p_val_adj<0.01),
         aes(label=subset(mapped_1421[[13]]$HGNC.symbol, 
                                         mapped_1421[[13]]$p_val_adj<0.01)),
                    size=2, 
                    box.padding=0.5, 
                    max.overlaps=Inf) +
  
       theme_minimal() +
       labs(title="HSC metabolic gene differential expression", 
             x="Average log fold change", 
             y="-log Adj. P-value")
```

```{r}
savepath = "~/Analysis/Immune/volcano_hsc.png"
ggsave(savepath,
       plot=last_plot(),
       device="png",
       width=10,
       height=6)
```
