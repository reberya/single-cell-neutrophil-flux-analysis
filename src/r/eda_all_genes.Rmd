---
title: "Immune cell exploratory data analysis (all genes)"
author: "Scott Campit"
output: 
  html_notebook:
    toc: yes
    theme: united
---

# Summary
This notebook performs data preprocessing on the initial seurat object. 

# 1. Load libraries
```{r}
library(mgcv)
library(splines)
library(Seurat)
library(tidyverse)
library(viridis)
library(matrixStats)
library(UpSetR)
library(reshape2)
library(ggplot2)
library(phateR)
library(reticulate)
#install.packages('readxl')
library(readxl)

#install.packages('sctransform')
library(sctransform)
```

# 2. Load the data
This code block does the following with the lung dataset:

  1. Log normalized.
  2. Scaling the data based on genes
  3. Get the Shared Nearest Neighbors. I'm using the default setting of 1:10, **but this can be optimized further.** 
  4. Identify clusters of cells by Shared Nearest Neighbors. Again, **the parameters can be optimized further.** 
  5. Run Uniform Manifold Approximation and Projection. Again, **the parameters can be optimized further.** 
  
Note that there were cell-type annotations in the meta data. I used those for visualization.
```{r}
rm(list=ls())
load("C:/Users/scott/Data/scRNASeq/shea/lung.robj", verbose=TRUE)
orig.ident = lung@active.ident
```

# 3. Visualize some QA/QC plots
Let's now visualize some global metrics of our data.
```{r}
FeatureScatter(object=lung, 
               feature1="nCount_RNA", 
               feature2="nFeature_RNA") + 
  theme_minimal() +
  labs(x="RNA Counts", 
       y="Number of Genes", 
       title="Gene count distribution")
```
# 4. Detecting Variable Genes
We should also visualize variable features. There are 3,000 highly variable genes in this dataset.
```{r}
lung = FindVariableFeatures(object=lung, 
                            mean.function=ExpMean,
                            dispersion.function=LogVMR,
                            selection.method='vst',
                            x.low.cutoff=-Inf,
                            x.high.cutoff=Inf,
                            y.cutoff=Inf,
                            nfeatures = 2000)
head(x=HVFInfo(object=lung))

top10 = head(VariableFeatures(lung), 20)
varfeat = VariableFeaturePlot(object=lung)
lbls = LabelPoints(plot=varfeat, 
                   points=top10, 
                   repel=TRUE)
lbls
```

Let's also visualize some additional QC metrics
```{r}
VlnPlot(lung, 
        features=c("nFeature_RNA", "nCount_RNA"), 
        ncol=2)
```

# 5. Eliminating confounding factors
First, we need to identify mitochondrial genes that may be confounding factors (based on the experimental design). We'll also normalize based on this known confounding factor.

Note - these need to be identified using Mitocarta.
```{r}
#lung = PercentageFeatureSet(lung, 
#                            pattern = "^Mt-", 
#                            col.name = "percent.mt")
#lung = SCTransform(lung,
#                    vars.to.regress="percent.mt", 
#                    verbose=FALSE)
```

Let's do that with ribosomal proteins as well, which are also known to confound the dataset. I need to figure out how to do this.
```{r}
#lung = PercentageFeatureSet(lung, 
#                            pattern = "^Rp[sl]", 
#                            col.name = "percent.ribo")
#lung = SCTransform(lung,
#                    vars.to.regress="percent.ribo", 
#                    verbose=FALSE)
```

# 6. Log Normalize and Scale the Data
Now let's log normalize the data.
```{r}
lung = NormalizeData(lung, 
                     normalization.method='LogNormalize', 
                     scale.factor=10000)
```

Now let's scale the data.
```{r}
all.genes = rownames(lung)
lung = ScaleData(lung, 
                 features=all.genes)
```

# 7. Run Principle Component Analysis

Now let's run PCA.
```{r}
lung = RunPCA(object=lung,
              npcs=50,
              verbose=FALSE)
```

We can visualize the elbow plot to see how much information is embedded.
```{r}
ElbowPlot(lung, ndims=100) +
  theme_minimal() +
  labs(title="Lung PCA Elbow Plot", 
       x="Principle Components", 
       y="Standard deviations")
```
We can also visualize the embedding using the `DimPlot()` function.
```{r}
DimPlot(object=lung, 
        reduction="pca") +
  labs(title="Lung Principle Component Embedding",
       x="PC 1",
       y="PC 2")
```

Finally let's also visualize the Loadings plot.
```{r}
VizDimLoadings(lung, 
               dims=1:10, 
               reduction="pca")
```

NOw let's visualize different principle components with up and downregulated genes.
```{r}
DimHeatmap(lung,
           dims=1:10, 
           cells=100,
           balanced=TRUE)
```
# 8. Perform some clustering
We'll now identify clusters and create the shared nearest neighbor embedding.
```{r}
lung = FindNeighbors(lung, 
                     dims=1:50,
                     reduction='pca')
lung = FindClusters(lung, 
                    resolution=0.5)
```

# 9. Perform UMAP
Let's run UMAP.
```{r}
lung = RunUMAP(lung, 
               dims=1:50)
```

# 10. Visualize data with original labels
This gets us to the visualization! Let's create the DimPlot() with the original labels.
```{r}
lung@active.ident=orig.ident
DimPlot(lung, 
        reduction="umap",
        dims=c(1, 2),
        label=TRUE,
        repel=TRUE,
        label.size=4,
        na.value = "grey50")
```
Let's visualize some specific genes
```{r}
genes_of_interests = c('Ldha', 'Glut1', 'Hk1', 
                         'Pfkfb3', 'Gapdh', 'Pdhk1',
                         'Hif1a')
VlnPlot(lung, features=genes_of_interests)
RidgePlot(lung, features=genes_of_interests)
```
Let's also visualize the data on the dimension reduction
```{r}
FeaturePlot(lung, 
            features=genes_of_interests,
            label=TRUE,
            repel=TRUE,
            label.size=4)
```

Find markers
```{r}
markers = FindAllMarkers(lung,
                         only.pos=TRUE,
                         min.pct = 0.25,
                         logfc.threshold=0.25)
markers %>% 
  group_by(cluster) %>% 
  top_n(n=2, 
        wt=avg_logFC)
```

Create a Heatmap of the top 20 markers for each cluster
```{r}
# Get top genes in all clusters
top10 = markers %>% 
  group_by(cluster) %>% 
  top_n(n=5, 
        wt=avg_logFC)

# Create the heatmap of top markers
DoHeatmap(lung, 
          features=top10$gene) + 
  NoLegend()
```

# 11. Visualize data with phenotype labels
Let's also plot with some of the additional metadata supplied.
```{r}
lung@active.ident=lung@meta.data$phenotype
DimPlot(lung, 
        reduction="umap",
        dims=c(1, 2),
        label=TRUE,
        repel=TRUE,
        label.size=4,
        na.value = "grey50") +
  NoLegend()
```

Let's use this to find distinct markers between different groups.
```{r}
lung.markers = FindAllMarkers(lung, 
                              only.pos=TRUE, 
                              min.pct=0.25, 
                              logfc.threshold=0.25)
lung.markers %>% group_by(cluster) %>% top_n(n=2, wt=avg_logFC)
FeaturePlot(lung, features=as.character(unique(lung.markers$gene)))
```