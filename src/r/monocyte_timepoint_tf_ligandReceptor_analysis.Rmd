---
title: "monocyte_timepoint_tf_ligandReceptor_analysis"
author: "Ryan Rebernick"
date: "3/10/2021"
output: html_document
---

# 1. Load packages and data
```{r, warning=F, message=F}

library('plyr')
library('dplyr')
library('magrittr')
library('data.table')

library(dorothea)
library(Seurat)
library(tibble)
library(pheatmap)
library(tidyr)
library(viper)
library(nichenetr)
library('tibble')
library(ComplexHeatmap)

# lung monocytes
load('/nfs/turbo/umms-csriram/scampit/Ryan/Projects/single-cell-neutrophil-flux-analysis/data/lung.mon.Robj')

# all lung cells
load('/nfs/turbo/umms-csriram/scampit/Ryan/Projects/single-cell-neutrophil-flux-analysis/data/lung.Robj')


```


# 2. Modify monocytes and lung metadata PRN
```{r, warning=F}

# Add disease vs healthy category
mon$dxHl <- ifelse(grepl('\\.h\\.', mon$sample), 'Hlthy', 'Dx')
lung$dxHl <- ifelse(grepl('\\.h\\.', lung$sample), 'Hlthy', 'Dx')


# Comparison category
mon$comp <- ifelse(mon$dxHl == 'Hlthy', 'Hlthy', mon$sample)
mon$comp <- factor(mon$comp, levels = c('Hlthy', 'lung.d.d7', 'lung.d.d14', 'lung.d.d21'))

```


# 3. Get TF activity per cluster using Dorothea
https://saezlab.github.io/dorothea/articles/single_cell_vignette.html
```{r}

# Regulons for mouse
dorothea_regulon_mouse <- get(data("dorothea_mm", package = "dorothea"))

# We obtain the regulons based on interactions with confidence level A, B and C
regulon <- dorothea_regulon_mouse %>%
    dplyr::filter(confidence %in% c("A","B","C"))

# set identities
Idents(mon) <- mon$comp

# We compute Viper Scores 
mon <- run_viper(mon, regulon,
                  options = list(method = "scale", minsize = 4, 
                                 eset.filter = FALSE, cores = 1, 
                                 verbose = FALSE))

# switch assay to dorothea, scale, run PCA, and find neighbors/clusters
DefaultAssay(object = mon) <- "dorothea"
mon <- ScaleData(mon)
mon <- RunPCA(mon, features = rownames(mon), verbose = FALSE)
mon <- FindNeighbors(mon, dims = 1:10, verbose = FALSE)
mon <- FindClusters(mon, resolution = 0.5, verbose = FALSE)

# Run umap
mon <- RunUMAP(mon, dims = 1:10, umap.method = "uwot", metric = "cosine")

# grab cluster markers
mon.markers <- FindAllMarkers(mon, only.pos = TRUE, min.pct = 0.25, 
                               logfc.threshold = 0.25, verbose = FALSE)


```


# 4. Plot heatmap of TF activity by cluster
## 4A. Prepare dataframe for plotting
The original documentation doesn't filter for factors expressed which makes zero sense to me. I used a mean expression of 0.5 as a cutoff for 'expressed' factors. This significantly narrowd the number of factors down. From 50 predicted ones, to 13 actually expressed.
```{r}

# set identity
Idents(mon) <- mon$comp

## We transform Viper scores, scaled by seurat, into a data frame to better 
## handling the results
viper_scores_df <- GetAssayData(mon, slot = "scale.data", 
                                    assay = "dorothea") %>%
  data.frame(check.names = F) %>%
  t()

## We create a data frame containing the cells and their clusters
CellsClusters <- data.frame(cell = names(Idents(mon)), 
                            cell_type = as.character(Idents(mon)),
                            check.names = F)

## We create a data frame with the Viper score per cell and its clusters
viper_scores_clusters <- viper_scores_df  %>%
  data.frame() %>% 
  rownames_to_column("cell") %>%
  gather(tf, activity, -cell) %>%
  inner_join(CellsClusters)

## We summarize the Viper scores by cellpopulation
summarized_viper_scores <- viper_scores_clusters %>% 
  dplyr::group_by(tf, cell_type) %>%
  dplyr::summarise(avg = mean(activity),
            std = sd(activity))


## We select the 50 most variable TFs. (200/4pops)
highly_variable_tfs <- summarized_viper_scores %>%
  dplyr::group_by(tf) %>%
  dplyr::mutate(var = var(avg))  %>%
  ungroup() %>%
  top_n(200, var) %>%
  distinct(tf)

## We prepare the data for the plot
summarized_viper_scores_df <- summarized_viper_scores %>%
  semi_join(highly_variable_tfs, by = "tf") %>%
  dplyr::select(-std) %>%   
  spread(tf, avg) %>%
  data.frame(row.names = 1, check.names = FALSE) 

# get highly variable tf mean expression (some factors missing) and compute if TFs expressed (average > 0.5)
Idents(mon) <- mon$orig.ident
cluster.averages <- as.data.frame(AverageExpression(mon)[["RNA"]])
cluster.averages %<>% 
  mutate(gene = rownames(cluster.averages)) %>%
  dplyr::filter(gene %in% highly_variable_tfs$tf) %>%
  mutate(all = as.numeric(all)) %>%
  select(-gene) %>%
  mutate(all = ifelse(all >0.5, 1, 0))

# Filter Dorothea TFs for those expressed
t_summarized_viper_scores_df <- as.data.frame(t(summarized_viper_scores_df))
expressed <- rownames(cluster.averages)[cluster.averages$all>0]
t_summarized_viper_scores_df %<>% dplyr::filter(rownames(.) %in% expressed)


```
## 4B.Plot Dorothea TF activities filtered by TF expression
Used a different heatmap plotting function because the documentation is 1000x better. Long live complexHeatmap
```{r, fig.height=10}

# color palette
palette_length = 100
my_color = colorRampPalette(c("Darkblue", "white","red"))(palette_length)

# create heatmap
h <- Heatmap(t_summarized_viper_scores_df,
        show_column_dend = F,
        show_row_dend = F,
        col = my_color,
        width = unit(1, "in"), 
        height = unit(3, "in"),
        column_order = c('Hlthy', 'lung.d.d7', 'lung.d.d14', 'lung.d.d21'),
        row_names_gp = gpar(fontsize = 8)
        ) 
h

# save to pdf
#pdf('/nfs/turbo/umms-csriram/scampit/Ryan/Projects/single-cell-neutrophil-flux-analysis/out/dorothea_neutrophils_expressed_TFs.pdf', height = 5.5, width = 2.5)
#h
#dev.off()

```




# NICHENET analysis

## Function to plot ligand target expression
```{r}

plotTargetExpression <- function(seurat_obj = mon, 
                                 group_by = 'comp', 
                                 genes = NULL,
                                 col_ord = NULL){
  
  # get expression for targets 
Idents(seurat_obj) <- seurat_obj@meta.data[group_by]
targets <- AverageExpression(seurat_obj)[["RNA"]]
targets <- targets[rownames(targets) %in% genes,]

# scale and normalize
targets = t(scale(t(targets), center =T, scale=T))

# color palette
palette_length = 100
my_color = colorRampPalette(c("darkorchid4", "white","orange"))(palette_length)

# Plot
H <- Heatmap(targets,
        show_column_dend = F,
        show_row_dend = F,
        col = my_color,
        width = unit(1, "in"), 
        height = unit(4, "in"),
        row_names_gp = gpar(fontsize = 8),
        column_order = col_ord
        ) 
H

}


```


## 5A. Load data required to run nichenet
```{r}
# Ligand target
#ligand_target_matrix = readRDS(url("https://zenodo.org/record/3260758/files/ligand_target_matrix.rds"))
ligand_target_matrix = readRDS('/nfs/turbo/umms-csriram/scampit/Ryan/Projects/single-cell-neutrophil-flux-analysis/data/ligand_target_matrix.rds')

# Ligand receptor
#lr_network = readRDS(url("https://zenodo.org/record/3260758/files/lr_network.rds"))
lr_network = readRDS('/nfs/turbo/umms-csriram/scampit/Ryan/Projects/single-cell-neutrophil-flux-analysis/data/lr_network.rds')


# weighted integrated network
#weighted_networks = readRDS(url("https://zenodo.org/record/3260758/files/weighted_networks.rds"))
weighted_networks = readRDS('/nfs/turbo/umms-csriram/scampit/Ryan/Projects/single-cell-neutrophil-flux-analysis/data/weighted_networks.rds')

```

## 5B. Nichenet - Day 7 disease vs Healthy
```{r}

# set default assayto RNA
DefaultAssay(object = mon) <- "RNA"
# set identities
Idents(mon) <- mon$CellType

# Run nichnet
nichenet_output = nichenet_seuratobj_aggregate(
  seurat_obj = mon, 
  receiver = "Monocytes", 
  condition_colname = "comp", condition_oi = "lung.d.d7", condition_reference = "Hlthy", 
  sender = "undefined", 
  ligand_target_matrix = ligand_target_matrix, lr_network = lr_network, weighted_networks = weighted_networks, organism = "mouse")

```
## Day 7 dx vs healthy Associated figures
```{r}
# plot target heatmap
nichenet_output$ligand_activity_target_heatmap

# Receptor interactions
nichenet_output$ligand_receptor_heatmap

# plot expression of ligands across celltypes by condition
DotPlot(lung, features = nichenet_output$top_ligands %>% rev(), split.by = "dxHl", dot.min = .1) + RotatedAxis()

# plot expression of receptors across monocytes by condition
Idents(mon) <- mon$comp
DotPlot(mon, features = nichenet_output$top_receptors %>% rev(), group.by = "comp", dot.min = .1) + RotatedAxis()

# plot expression of targets
plotTargetExpression(seurat_obj = mon, group_by = 'comp', genes = nichenet_output$top_targets, 
                     col_ord = c('Hlthy', 'lung.d.d7', 'lung.d.d14', 'lung.d.d21'))

```

## 5C. Nichenet - Day 14 disease vs Healthy
```{r}

# set default assayto RNA
DefaultAssay(object = mon) <- "RNA"
# set identities
Idents(mon) <- mon$CellType

# Run nichnet
nichenet_output = nichenet_seuratobj_aggregate(
  seurat_obj = mon, 
  receiver = "Monocytes", 
  condition_colname = "comp", condition_oi = "lung.d.d14", condition_reference = "Hlthy", 
  sender = "undefined", 
  ligand_target_matrix = ligand_target_matrix, lr_network = lr_network, weighted_networks = weighted_networks, organism = "mouse")

```
## Day 14 dx vs healthy Associated figures
```{r}
# plot target heatmap
nichenet_output$ligand_activity_target_heatmap

# Receptor interactions
nichenet_output$ligand_receptor_heatmap

# plot expression of ligands across celltypes by condition
DotPlot(lung, features = nichenet_output$top_ligands %>% rev(), split.by = "dxHl", dot.min = .1) + RotatedAxis()

# plot expression of receptors across monocytes by condition
Idents(mon) <- mon$comp
DotPlot(mon, features = nichenet_output$top_receptors %>% rev(), group.by = "comp", dot.min = .1) + RotatedAxis()

# plot expression of targets
plotTargetExpression(seurat_obj = mon, group_by = 'comp', genes = nichenet_output$top_targets, 
                     col_ord = c('Hlthy', 'lung.d.d7', 'lung.d.d14', 'lung.d.d21'))


```

## 5D. Nichenet - Day 21 disease vs Healthy
```{r}

# set default assayto RNA
DefaultAssay(object = mon) <- "RNA"
# set identities
Idents(mon) <- mon$CellType

# Run nichnet
nichenet_output = nichenet_seuratobj_aggregate(
  seurat_obj = mon, 
  receiver = "Monocytes", 
  condition_colname = "comp", condition_oi = "lung.d.d21", condition_reference = "Hlthy", 
  sender = "undefined", 
  ligand_target_matrix = ligand_target_matrix, lr_network = lr_network, weighted_networks = weighted_networks, organism = "mouse")

```
## Day 21 dx vs healthy Associated figures
```{r}
# plot target heatmap
nichenet_output$ligand_activity_target_heatmap

# Receptor interactions
nichenet_output$ligand_receptor_heatmap

# plot expression of ligands across celltypes by condition
DotPlot(lung, features = nichenet_output$top_ligands %>% rev(), split.by = "dxHl", dot.min = .1) + RotatedAxis()

# plot expression of receptors across monocytes by condition
Idents(mon) <- mon$comp
DotPlot(mon, features = nichenet_output$top_receptors %>% rev(), group.by = "comp", dot.min = .1) + RotatedAxis()

# plot expression of targets
plotTargetExpression(seurat_obj = mon, group_by = 'comp', genes = nichenet_output$top_targets, 
                     col_ord = c('Hlthy', 'lung.d.d7', 'lung.d.d14', 'lung.d.d21'))


```


## 5E. Nichenet - Day 14 disease vs Day 7 Disease
```{r}

# set default assayto RNA
DefaultAssay(object = mon) <- "RNA"
# set identities
Idents(mon) <- mon$CellType

# Run nichnet
nichenet_output = nichenet_seuratobj_aggregate(
  seurat_obj = mon, 
  receiver = "Monocytes", 
  condition_colname = "comp", condition_oi = "lung.d.d14", condition_reference = "lung.d.d7", 
  sender = "undefined", 
  ligand_target_matrix = ligand_target_matrix, lr_network = lr_network, weighted_networks = weighted_networks, organism = "mouse")

```
## Day 14 dx vs Day 7 disease Associated figures
```{r}
# plot target heatmap
nichenet_output$ligand_activity_target_heatmap

# Receptor interactions
nichenet_output$ligand_receptor_heatmap

# plot expression of ligands across celltypes by condition
DotPlot(lung, features = nichenet_output$top_ligands %>% rev(), split.by = "dxHl", dot.min = .1) + RotatedAxis()

# plot expression of receptors across monocytes by condition
Idents(mon) <- mon$comp
DotPlot(mon, features = nichenet_output$top_receptors %>% rev(), group.by = "comp", dot.min = .1) + RotatedAxis()

# plot expression of targets
plotTargetExpression(seurat_obj = mon, group_by = 'comp', genes = nichenet_output$top_targets, 
                     col_ord = c('Hlthy', 'lung.d.d7', 'lung.d.d14', 'lung.d.d21'))


```

## 5F. Nichenet - Day 21 disease vs Day 14 disease
```{r}

# set default assayto RNA
DefaultAssay(object = mon) <- "RNA"
# set identities
Idents(mon) <- mon$CellType

# Run nichnet
nichenet_output = nichenet_seuratobj_aggregate(
  seurat_obj = mon, 
  receiver = "Monocytes", 
  condition_colname = "comp", condition_oi = "lung.d.d21", condition_reference = "lung.d.d14", 
  sender = "undefined", 
  ligand_target_matrix = ligand_target_matrix, lr_network = lr_network, weighted_networks = weighted_networks, organism = "mouse")

```
## Day 21 dx vs Day 14 dx Associated figures
```{r}
# plot target heatmap
nichenet_output$ligand_activity_target_heatmap

# Receptor interactions
nichenet_output$ligand_receptor_heatmap

# plot expression of ligands across celltypes by condition
DotPlot(lung, features = nichenet_output$top_ligands %>% rev(), split.by = "dxHl", dot.min = .1) + RotatedAxis()

# plot expression of receptors across monocytes by condition
Idents(mon) <- mon$comp
DotPlot(mon, features = nichenet_output$top_receptors %>% rev(), group.by = "comp", dot.min = .1) + RotatedAxis()

# plot expression of targets
plotTargetExpression(seurat_obj = mon, group_by = 'comp', genes = nichenet_output$top_targets, 
                     col_ord = c('Hlthy', 'lung.d.d7', 'lung.d.d14', 'lung.d.d21'))


```

## 5G. Nichenet - Day 21 disease vs all other monocytes
```{r}

# new metadata category for comparison
mon$all21 <- ifelse(mon$sample == 'lung.d.d21', 'lung.d.d21', 'allOtherMon')

# set default assayto RNA
DefaultAssay(object = mon) <- "RNA"
# set identities
Idents(mon) <- mon$CellType

# Run nichnet
nichenet_output = nichenet_seuratobj_aggregate(
  seurat_obj = mon, 
  receiver = "Monocytes", 
  condition_colname = "all21", condition_oi = "lung.d.d21", condition_reference = "allOtherMon", 
  sender = "undefined", 
  ligand_target_matrix = ligand_target_matrix, lr_network = lr_network, weighted_networks = weighted_networks, organism = "mouse")

```
## Day 21 dx vs all other monocytes Associated figures
```{r}
# plot target heatmap
nichenet_output$ligand_activity_target_heatmap

# Receptor interactions
nichenet_output$ligand_receptor_heatmap

# plot expression of ligands across celltypes by condition
DotPlot(lung, features = nichenet_output$top_ligands %>% rev(), split.by = "dxHl", dot.min = .1) + RotatedAxis()

# plot expression of receptors across monocytes by condition
Idents(mon) <- mon$comp
DotPlot(mon, features = nichenet_output$top_receptors %>% rev(), group.by = "comp", dot.min = .1) + RotatedAxis()

# plot expression of targets
plotTargetExpression(seurat_obj = mon, group_by = 'comp', genes = nichenet_output$top_targets, 
                     col_ord = c('Hlthy', 'lung.d.d7', 'lung.d.d14', 'lung.d.d21'))


```
















