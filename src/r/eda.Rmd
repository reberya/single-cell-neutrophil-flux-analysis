---
title: "Immune cell exploratory data analysis"
author: "Scott Campit"
output: 
  html_notebook:
    toc: yes
    theme: united
---

# Summary
This analysis contains 3 time points: :

  1. 7 days: Pre-metastatic niche - tumor cells have not arrived
  2. 14 days: Metastatic niche - tumor cells arrived but no proliferation
  3. 21 days: Metabstatic niche - secondary tumors in lung 

**The overall hypothesis** is that immune cells at the early metastatic niche have an anti-tumor phenotype, while immune cells have a pro-metastatic niche in the late-stage.

I will be testing the following hypotheses that are reported across multiple studies using COBRA:
  * Glutathione metabolism will go down from the early stage to late stage metastatic niche.
  * Glycolysis will go up from the early stage to late stage metastatic niche.
  * OXPHOS goes down from early stage to late stage metastatic niche.
  
These are the known hypotheses that can support what already been known. Some additional questions I can attempt to answer include:
  * What are distinct metabolic flux alterations that occur in different immune cells?

# Exploratory data analysis
First, we'll load the libraries and dataset we'll need to analyze the data.

```{r}
# Load the libraries
library(mgcv)
library(splines)
library(Seurat)
library(dplyr)
library(tidyr)
library(viridis)
library(matrixStats)
library(UpSetR)
library(reshape2)
library(ggplot2)
library(phateR)

# Load the data
load("D:/Data/scRNASeq/shea/lung.robj", verbose=TRUE)
```

Now, let's get a high level overview of the data using t-SNE and UMAP.
```{r}
# Sophia already ran tSNE
DimPlot(lung, reduction="tsne")

# Let's also run UMAP to see if we get better separation
#lung = RunUMAP(lung, dims=1:50)
#save(lung, file="D:/Data/scRNASeq/shea/lung.robj")
DimPlot(lung, reduction="umap")
```
Now I see why they used the t-SNE method for dimension reduction rather than the UMAP representation. 

# Differential expression analysis
## Aggregated differential expression analysis
I would need to perform differential expression analysis across populations of cells, using each time point compared to the previous time point. That is what they did in figure 2D.

```{r}
celltype.list = SplitObject(lung, split.by="CellType")
celltypes = c("Stroma", "Alveolar Macrophages", "Macrophages", "Monocytes",
              "Pneumocytes", "B cells", "Granulocytes", "T cells",
              "Dendritic Cells", "Neutrophils", "NK cells", "Endothelial",
              "HSCs")

# Differential expression for different time points across different cell types
t0007_de = list()
t0714_de = list()
t1421_de = list()
for(i in 1:length(celltype.list)){
  tissuedata = SetIdent(celltype.list[[i]], value="Time")
  t0007_de[[i]] = FindMarkers(tissuedata, ident.1=0, indent.2=7)
  t0714_de[[i]] = FindMarkers(tissuedata, ident.1=7, indent.2=14)
  t1421_de[[i]] = FindMarkers(tissuedata, ident.1=14, indent.2=21)
}

cnt_mat = matrix(, nrow=13, ncol=4)
for(i in 1:length(celltype.list)){
  cnt_mat[i, 1] = sum(celltype.list[[i]]@meta.data$Time == 0)
  cnt_mat[i, 2] = sum(celltype.list[[i]]@meta.data$Time == 7)
  cnt_mat[i, 3] = sum(celltype.list[[i]]@meta.data$Time == 14)
  cnt_mat[i, 4] = sum(celltype.list[[i]]@meta.data$Time == 21)
}

```
Now we can save the data.

```{r}
save.image(file="D:/Data/scRNASeq/shea/lung_agg_de.RData")
```

## Individual cell differential expression analysis
